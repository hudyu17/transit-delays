---
title: "data-exploration"
output: html_document
date: '2022-04-07'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(data.table)
library(lubridate)
library(rcompanion)
library(AICcmodavg)
```

# Load data
```{r}
df <- readRDS('../inputs/bus-clean.RDS')

head(df)
```

# Summary stats
## Delay over time
```{r}
df[, month_year := format(as.Date(df$report_date), "%Y-%m")]

df[, year := format(as.Date(df$report_date), "%Y")]

incidents <- unique(df[, incident])
for (curr_incident in incidents) {
  p <- df[incident == curr_incident, mean(min_delay), by=month_year] %>%
    ggplot(aes(x=month_year, y=V1, group=1)) +
    geom_line() +
    ggtitle(curr_incident)
  
  plot(p)
}

```
## Delay by day of week
```{r}
df[incident == 'Mechanical', mean(min_delay), by=day] %>%
    ggplot(aes(x= reorder(day,-V1), y=V1)) + 
    geom_bar(stat="identity") 
```
# Quick modelling
## Check distribution of delays
```{r}
# exploration, no need to run
df %>%
  ggplot(aes(x=min_delay)) + 
  geom_histogram()

delay <- df[, min_delay]
qqnorm(delay, ylab="Quantiles for delay")
qqline(delay, col="red") # clearly right skewed

# applying log transformation
delay_log = log(delay)
delay_log <- delay_log[!is.infinite(delay_log)]
plotNormalHistogram(delay_log)
```


```{r}
# apply this to the actual data frame
df[, delay_log := log(min_delay)]
df <- df[!is.infinite(delay_log)]

# trying to cast the hour out
df[, hour := substr(time, 1, 2)] # keep as character because categorical
head(df)
```



```{r}
df2015 <- df[report_date %between% c('2015-01-01', '2015-12-31')]
length(unique(df2015[, route]))

model <- lm(delay_log ~ day + incident + hour, data = df2015) # TODO: use hour as variable but can't figure it out above lol
anova(model) # show results
summary(model)
plot(model)

two_way_day_incident <- aov(delay_log ~ day + incident, data = df2015)
two_way_day_hour <- aov(delay_log ~ day + hour, data = df2015)
two_way_incident_hour <- aov(delay_log ~ hour + incident, data = df2015)

interaction_day_incident <- aov(delay_log ~ day * incident, data = df2015)
interaction_day_hour <- aov(delay_log ~ day * hour, data = df2015)
interaction_incident_hour <- aov(delay_log ~ hour * incident, data = df2015)

combine_day_incident_plus_hour <- aov(delay_log ~ day * incident + hour, data = df2015)
combine_incident_hour_plus_day <- aov(delay_log ~ day + incident * hour, data = df2015)
combine_day_hour_plus_incident <- aov(delay_log ~ day * hour + incident, data = df2015)

model.set <- list(
  two_way_day_incident, 
  two_way_day_hour, 
  two_way_incident_hour, 
  interaction_day_incident, 
  interaction_day_hour, 
  interaction_incident_hour, 
  combine_day_incident_plus_hour, 
  combine_incident_hour_plus_day,
  combine_day_hour_plus_incident
)

model.names <- c(
  'two_way_day_incident', 
  'two_way_day_hour', 
  'two_way_incident_hour', 
  'interaction_day_incident', 
  'interaction_day_hour', 
  'interaction_incident_hour', 
  'combine_day_incident_plus_hour', 
  'combine_incident_hour_plus_day',
  'combine_day_hour_plus_incident'
)

aictab(model.set, modnames = model.names)
```
```{r}
summary(combine_incident_hour_plus_day)
TukeyHSD(combine_incident_hour_plus_day)
```

# anova for delay over time using month-year
```{r}
month_year_aov <- aov(delay_log ~ month_year, data = df)
summary(month_year_aov)

df[, mean(min_delay), by=month_year] %>%
    ggplot(aes(x=month_year, y=V1, group=1)) +
    geom_line() 

year_aov <- aov(delay_log ~ year, data = df)
summary(year_aov)

year_model <- lm(min_delay ~ year, data = df)
summary(year_model)

df[, mean(min_delay), by=year] %>%
    ggplot(aes(x=year, y=V1, group=1)) +
    geom_line() 
```


# rough work below
```{r}
qqnorm(residuals(model),
       ylab="Sample Quantiles for residuals")

plot(fitted(model),
     residuals(model))

model_day <- lm(delay_log ~ day, data = df2015)
summary(model_day)

model_incident <- lm(delay_log ~ incident, data = df2015)
summary(model_incident)
anova(model_incident)
plot(model_incident)

df2015 %>%
  ggplot(aes(x=incident, y=min_delay)) + 
  geom_bar(stat="identity") 

df2015[incident == 'Mechanical'] %>%
  ggplot(aes(x=day, y=min_delay)) + 
  stat_summary(fun.y = "mean", geom = "bar")

df2015[incident == 'Mechanical'] %>%
  ggplot(aes(x=hour, y=min_delay)) + 
  stat_summary(fun.y = "mean", geom = "bar")

df2015 %>%
  ggplot(aes(x=hour, y=min_delay)) + 
  # geom_bar(stat="identity") 
  stat_summary(fun.y = "mean", geom = "bar")

df2015[hour == '14', sum(min_delay)]
```

